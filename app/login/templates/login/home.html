<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title> YOLO </title>
    {% load staticfiles %}
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <link href="{% static 'login/style.css' %}" rel="stylesheet" type="text/css">
    <link href = "https://bootswatch.com/4/minty/bootstrap.min.css" rel = "stylesheet" type = "text/css">
  </head> 

  <body id = "registerbod">
	  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300" type="text/css" />
      <div id = "wrapper">

        <!-- sidebar -->

        <div id = "sidebar-wrapper">
          <ul>
            <li> <a href = "{% url 'login' %}"> Login </a> </li>
            <br>
            <li> <a href = "{% url 'register' %}"> Register </a> </li>
          </ul>
        </div>

        <div id = "page-content-wrapper">
          <div class = "container-fluid">
            <div class = "row">
              <div class = "col-lg-12">
                <a href= "#" class = "btn-btn-success" id = "menu-toggle"> 
                  <span class="glyphicon glyphicon-menu-hamburger" aria-hidden="true"></span>
                  <div id  ="logo_img">
                    <img src = "https://i.ibb.co/f9kDp9Y/1bd9cbba-6871-40ea-8001-e77bd4f24bfc.png">
                  </div>
                </a>
              </div>
            </div>
            <br>
            <br>
            <div class = "row" id = "body-main-content">
              <div class = "col-lg-12">
                <br>
                <p id = "instr"> Please say the following phrase after clicking the start button.</p>
                <p id = "randphrase"> PlaceHolder </p>
                <br>
                <br>
                <br>
                <br>
                <br>
              </div>
              <div class = "col-lg-12" id = "buts">
                <div id = "recbuts">
                  <input type = "button" id = "startrec1" class = "glyphicon glyphicon-play" value = "">
                </div>
              </div>
              <div class = "col-lg-12">
                <br>
                <br>
              </div>
            </div>
            <div class = "row" id = "animation-body" style="display: none;">
              <div id="bars">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
              </div>
            </div>
          </div>
        </div>
      </div>


      <script> 

        setInterval(function() {
          sentence();
        }, 9000);

        /* menu toggle */

        $("#menu-toggle").click( function(e) {
          e.preventDefault();
          $("#wrapper").toggleClass("menuDisplayed");
        });

        /*end menu toggle */

        /*Code for recording from microphone reference: https://addpipe.com/blog/using-recorder-js-to-capture-wav-audio-in-your-html5-web-site/ */

        URL = window.URL || window.webkitURL;
        var gumStream;            
        var rec;              
        var input;            
        var AudioContext = window.AudioContext || window.webkitAudioContext;
        var audioContext 
        var recordButton = document.getElementById("startrec1");
        recordButton.addEventListener("click", start_stop);
        var item;

		    var recording = false;
		    function start_stop() {
			   if (recording) {
				  recording = false
				  stopRecording();
			 }
			 else{
		  		recording = true;
		  		startRecording()
		  	}
		  }

        function startRecording() {
          console.log("IN START RECORDING");
          document.getElementById("instr").innerHTML = "Please click the stop button once you are done recording.";
          var constraints = { audio: true, video:false }
          navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
            audioContext = new AudioContext();
            gumStream = stream;
            input = audioContext.createMediaStreamSource(stream);
            rec = new Recorder(input,{numChannels:1})
            rec.record()
            var buttons = document.getElementById("startrec1");
            buttons.style.background = 'url(https://i.ibb.co/fSRFf2q/stop-82x82.png) no-repeat';

          }).catch(function(err) {
          });
        }

        window.onload = function() {
          sentence();
        };

        function stopRecording() {
          document.getElementById('animation-body').style.display = 'block';
          var buttons = document.getElementById("startrec1");
          buttons.style.background = 'url(https://i.ibb.co/C5zk8Rk/start-82x82.png) no-repeat';
          rec.stop();
          gumStream.getAudioTracks()[0].stop();
          rec.exportWAV(createDownloadLink);

        }

        function getCSRFToken() {
          var cookies = document.cookie.split(";");
          for (var i = 0; i < cookies.length; i++) {
              c = cookies[i].trim();
              if (c.startsWith("csrftoken=")) {
                  return c.substring("csrftoken=".length, c.length);
              }
          }
          return "unknown";
        }

        function createDownloadLink(blob) {
          var url = URL.createObjectURL(blob);
          var au = document.createElement('audio');
          var li = document.createElement('li');
          var link = document.createElement('a');
          var filename = new Date().toISOString();
          au.controls = true;
          au.src = url;
          link.href = url;
          link.download = filename+".wav"; 
          link.innerHTML = "Save to disk";
          li.appendChild(au);
          li.appendChild(document.createTextNode(filename+".wav "))
          li.appendChild(link);
          li.appendChild(document.createTextNode (" "));
          console.log(blob);
          var url = "/login";                                
		      var formData = new FormData();
		      formData.append('picture', blob);
          formData.append('text', item);

		      $.ajax({
		        url: url, 
		        type: "POST", 
		        cache: false,
		        contentType: false,
		        processData: false,
		        data: formData})
		            .done(function(e){
                  var name = e['username'];
                  if(name != "None"){
                    console.log("IN IFFFFFF")
                    location.href="/welcome/"+name;
                  }
                  else{
                    console.log("IN ELSE!!!!!!")
                    alert("User was not found!");
                    document.getElementById('animation-body').style.display = 'none';
                  }

		            });
          }

        /*Sentence Generation */

        var verbs, nouns, adjectives, adverbs, preposition;
        nouns = ["bird", "clock", "boy", "plastic", "duck", "teacher", "old lady", "professor", "hamster", "dog"];
        verbs = ["kicked", "ran", "flew", "dodged", "sliced", "rolled", "died", "breathed", "slept", "killed"];
        adjectives = ["beautiful", "lazy", "professional", "lovely", "dumb", "rough", "soft", "hot", "vibrating", "slimy"];
        adverbs = ["slowly", "elegantly", "precisely", "quickly", "sadly", "humbly", "proudly", "shockingly", "calmly", "passionately"];
        preposition = ["down", "into", "up", "on", "upon", "below", "above", "through", "across", "towards"];

        function randGen() {
          return Math.floor(Math.random() * 5);
        }

        function sentence() {
          var rand1 = Math.floor(Math.random() * 10);
          var rand2 = Math.floor(Math.random() * 10);
          var rand3 = Math.floor(Math.random() * 10);
          var rand4 = Math.floor(Math.random() * 10);
          var rand5 = Math.floor(Math.random() * 10);
          var rand6 = Math.floor(Math.random() * 10);
          //                var randCol = [rand1,rand2,rand3,rand4,rand5];
          //                var i = randGen();
          var content = "The " + adjectives[rand1] + " " + nouns[rand2] + " " + adverbs[rand3] + " " + verbs[rand4] + " because some " + nouns[rand1] + " " + adverbs[rand1] + " " + verbs[rand1] + " " + preposition[rand1] + " a " + adjectives[rand2] + " " + nouns[rand5] + " which, became a " + adjectives[rand3] + ", " + adjectives[rand4] + " " + nouns[rand6] + ".";
          item = content;
          document.getElementById('randphrase').innerHTML = "&quot;" + content + "&quot;";
        };

        /*End of sentence generation */

        function sleep(ms) {
          return new Promise(resolve => setTimeout(resolve, ms));
        }

        function getRandomInt(max) {
          return Math.floor(Math.random() * Math.floor(max));
        }

      </script>

      <script src="https://cdn.rawgit.com/mattdiamond/Recorderjs/08e7abd9/dist/recorder.js"></script> 
  </body>
</html>