<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title> YOLO </title>
    {% load staticfiles %}
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript">
          $(document).ready(function() {
	          setTimeout(function(){
	              $('body').addClass('loaded');
	          }, 3000);

	      });
	  </script>

    <link href="{% static 'login/style.css' %}" rel="stylesheet" type="text/css">
  </head> 

  <body>
      <div id = "buttabs">
        <input type = "button" id = "loginbut" type = "submit" value ="Login" 
        onclick="location.href='{% url 'events' %}';">
        <input type = "button" id = "signupbut" type = "submit" onclick="location.href='{% url 'events1' %}';" value = "Register">
      </div>
      <br>
      <!--<div id = "nameInfo">
		<input type = "text" id = "nameInp" name = "userName" placeHolder = "Enter name"/>
      </div>-->
      <div id = "info">
        <p id = "instr">Please say the following phrase after clicking the start recording button.</p>
        <br>
        <p id = "randphrase"> PlaceHolder </p>
        <div id = "recbuts">
          <input type = "button" id = "startrec" class = "record" value = "">
        </div>
      </div>
      <div id = "recordings">
        <ol id="recordingsList"></ol>
      </div>

      <script> 

        /*Code for recording from microphone reference: https://addpipe.com/blog/using-recorder-js-to-capture-wav-audio-in-your-html5-web-site/ */

        URL = window.URL || window.webkitURL;

        var gumStream;            
        var rec;              
        var input;            
        var AudioContext = window.AudioContext || window.webkitAudioContext;
        var audioContext 
        var recordButton = document.getElementById("startrec");
        //var stopButton = document.getElementById("stoprec");
        recordButton.addEventListener("click", start_stop);
        //stopButton.addEventListener("click", stopRecording);

		var recording = false;
		function start_stop() {
			if (recording) {
				recording = false
				stopRecording();
			}
			else{
				recording = true;
				startRecording()
			}

		}

        function startRecording() {
          console.log("IN START RECORDING");
          var constraints = { audio: true, video:false }
          navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
            audioContext = new AudioContext();
            gumStream = stream;
            input = audioContext.createMediaStreamSource(stream);
            rec = new Recorder(input,{numChannels:1})
            rec.record()
          }).catch(function(err) {
          });
        }

        window.onload = function() {
          getText();
        };

        function stopRecording() {
          rec.stop();
          gumStream.getAudioTracks()[0].stop();
          rec.exportWAV(createDownloadLink);
        }

        function getCSRFToken() {
          var cookies = document.cookie.split(";");
          for (var i = 0; i < cookies.length; i++) {
              c = cookies[i].trim();
              if (c.startsWith("csrftoken=")) {
                  return c.substring("csrftoken=".length, c.length);
              }
          }
          return "unknown";
        }

        function createDownloadLink(blob) {
          var url = URL.createObjectURL(blob);
          var au = document.createElement('audio');
          var li = document.createElement('li');
          var link = document.createElement('a');
          var filename = new Date().toISOString();
          au.controls = true;
          au.src = url;
          link.href = url;
          link.download = filename+".wav"; 
          link.innerHTML = "Save to disk";
          li.appendChild(au);
          li.appendChild(document.createTextNode(filename+".wav "))
          li.appendChild(link);
          li.appendChild(document.createTextNode (" "))
          console.log(blob);
          

          var url = "/login";                                
		  var formData = new FormData();
		  formData.append('picture', blob);

		  $.ajax({
		      url: url, 
		      type: "POST", 
		      cache: false,
		      contentType: false,
		      processData: false,
		      data: formData})
		          .done(function(e){
		          });
        }

        function getText(){
          // read text from URL location
          console.log('in start function')
          var request = new XMLHttpRequest();
          request.open('GET', 'https://raw.githubusercontent.com/dwyl/english-words/master/words_alpha.txt', true);
          request.send(null);
          request.onreadystatechange = function () {
          	  console.log('in getText')
              if (request.readyState === 4 && request.status === 200) {
                  var type = request.getResponseHeader('Content-Type');
                  if (type.indexOf("text") !== 1) {
                  	  console.log('in second IF')
                      text = request.responseText;
                      text = text.split('\n');
                      length_array = text.length;
                      word1 = text[getRandomInt(length_array)];
                      word2 = text[getRandomInt(length_array)];
                      word3 = text[getRandomInt(length_array)];
                      word4 = text[getRandomInt(length_array)];
                      word5 = text[getRandomInt(length_array)];
                      var new__phrase = [];
                      new__phrase.push(word1," ",word2," ", word3, " ", word4, " ", word5);
                      document.getElementById("randphrase").innerHTML = new__phrase.join("");
                      return;
                  }
              }
            }
        }

        function sleep(ms) {
          return new Promise(resolve => setTimeout(resolve, ms));
        }

        function getRandomInt(max) {
          return Math.floor(Math.random() * Math.floor(max));
        }



      </script>
      <script src="https://cdn.rawgit.com/mattdiamond/Recorderjs/08e7abd9/dist/recorder.js"></script> 
  </body>
</html>




